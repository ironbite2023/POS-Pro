# DELIVERY PLATFORM CREDENTIALS & SECRETS WORKFLOW

**Analysis Date**: October 6, 2025  
**Status**: Credential Management System Overview  
**Security Level**: Current vs Recommended

---

## 🔑 **CREDENTIAL ARCHITECTURE OVERVIEW**

Our delivery platform integration requires **two distinct types of secrets**:

### **1. Platform API Credentials (User-Managed)**
These are obtained from each platform's developer portal and entered by restaurant owners via the UI.

### **2. Webhook Secrets (System-Managed)**  
These are generated by the platforms for webhook signature verification and must be stored securely.

---

## 📋 **REQUIRED CREDENTIALS BY PLATFORM**

### **🟢 Uber Eats Credentials**

#### **API Credentials (User Enters via UI):**
- **`client_id`** - OAuth Client ID from Uber Eats Developer Portal
- **`client_secret`** - OAuth Client Secret (highly sensitive)
- **`store_id`** - Unique store identifier on Uber Eats platform

#### **Webhook Secrets (System Environment):**
- **`UBER_EATS_CLIENT_SECRET`** - Used for webhook signature verification (same as OAuth secret)

**Where to Obtain:**
```
🔗 https://developer.uber.com/dashboard/
   → Create App → Get Client Credentials
   → Partner Portal → Get Store ID
```

### **🟠 Deliveroo Credentials**

#### **API Credentials (User Enters via UI):**
- **`client_id`** - OAuth Client ID from Deliveroo Developer Portal
- **`client_secret`** - OAuth Client Secret (highly sensitive)  
- **`restaurant_id`** - Unique restaurant identifier on Deliveroo platform

#### **Webhook Secrets (System Environment):**
- **`DELIVEROO_WEBHOOK_SECRET`** - Separate webhook signing secret from Deliveroo

**Where to Obtain:**
```
🔗 https://developer.deliveroo.com/
   → API Credentials → Get Client Credentials
   → Partner Portal → Get Restaurant ID
   → Webhook Settings → Get Webhook Secret
```

### **🔵 Just Eat Credentials**

#### **API Credentials (User Enters via UI):**
- **`api_token`** - Bearer token from Just Eat Partner Centre (no OAuth needed)
- **`restaurant_id`** - Unique restaurant identifier on Just Eat platform

#### **Webhook Secrets (System Environment):**
- **`JUST_EAT_WEBHOOK_SECRET`** - Webhook signing secret from Just Eat Partner Centre

**Where to Obtain:**
```
🔗 https://developers.just-eat.com/ 
   → Partner Centre → API Settings → Get Bearer Token
   → Restaurant Settings → Get Restaurant ID
   → Webhook Configuration → Get Webhook Secret
```

---

## 🔄 **COMPLETE CREDENTIAL WORKFLOW**

### **Phase 1: Platform Setup (One-Time per Platform)**

#### **Step 1: User Navigates to Platform Settings**
- Route: `/delivery/platform-settings`
- UI: `src/app/(default)/delivery/platform-settings/page.tsx`

#### **Step 2: User Clicks "Add Platform Integration"**
- Opens: `PlatformSetupWizard` component
- Shows: Platform selection and credential form

#### **Step 3: User Enters Platform Credentials**
- UI: `PlatformCredentialsForm` component
- Collects platform-specific fields (see table above)
- **Fields are password-masked** for security

#### **Step 4: Credentials Saved to Database**
```typescript
// Via deliveryPlatformService.upsertPlatformIntegration()
const credentialsJson = JSON.parse(JSON.stringify(integration.credentials)) as Json;

await supabase
  .from('platform_integrations')
  .upsert({
    organization_id: integration.organization_id,
    platform: integration.platform,
    platform_restaurant_id: integration.platform_restaurant_id,
    credentials: credentialsJson, // 🚨 Currently stored as JSONB in database
    webhook_url: generateWebhookUrl(platform, organizationId),
    is_active: false,
  });
```

#### **Step 5: Connection Testing**
- UI: `WebhookTestConsole` component
- Tests API connectivity with entered credentials
- Activates integration if test passes

---

## 🗄️ **CURRENT CREDENTIAL STORAGE**

### **Database Storage (Current Implementation):**

**Table**: `platform_integrations`
```sql
CREATE TABLE platform_integrations (
    id UUID PRIMARY KEY,
    organization_id UUID REFERENCES organizations(id),
    platform platform_enum NOT NULL,
    platform_restaurant_id TEXT NOT NULL,
    credentials JSONB NOT NULL, -- 🚨 Currently stores actual credentials
    webhook_url TEXT,
    settings JSONB DEFAULT '{}',
    is_active BOOLEAN DEFAULT FALSE,
    -- ... other fields
);
```

**Example Storage:**
```json
{
  "credentials": {
    "client_id": "uber_eats_client_id_123",
    "client_secret": "uber_secret_xyz789", // 🚨 SENSITIVE DATA IN DB
    "store_id": "store_456"
  }
}
```

### **🚨 SECURITY CONCERN:**
**Current**: Credentials stored as plain JSONB in database  
**Risk**: Database breach exposes all platform API credentials  
**Recommended**: Migrate to Supabase Vault for sensitive data  

---

## 🔒 **WEBHOOK SECRET MANAGEMENT (CRITICAL GAP)**

### **Current Status: ❌ INCOMPLETE**

Our webhook functions expect environment variables but **there's no system to manage them**:

```typescript
// In Edge Functions:
const webhookSecret = Deno.env.get('DELIVEROO_WEBHOOK_SECRET'); // ❌ Not set
const clientSecret = Deno.env.get('UBER_EATS_CLIENT_SECRET');   // ❌ Not set
const webhookSecret = Deno.env.get('JUST_EAT_WEBHOOK_SECRET');  // ❌ Not set
```

### **🚨 CRITICAL ISSUE:**
**No system currently exists to set these environment variables in Supabase Edge Functions!**

---

## 🛠️ **RECOMMENDED CREDENTIAL MANAGEMENT SOLUTION**

### **Solution Architecture:**

#### **1. API Credentials → Database (Current, with Vault Migration)**
```typescript
// Current (JSONB storage)
credentials: {
  "client_id": "actual_value",      // 🚨 Exposed in DB
  "client_secret": "actual_value"   // 🚨 Highly sensitive
}

// Recommended (Vault references)
credentials: {
  "client_id_vault_key": "uber_eats_org123_client_id",
  "client_secret_vault_key": "uber_eats_org123_client_secret"
}
```

#### **2. Webhook Secrets → Supabase Project Settings**
Platform webhook secrets should be stored as **Supabase project environment variables**.

---

## ⚙️ **COMPLETE SETUP WORKFLOW (RECOMMENDED)**

### **Phase 1: System Administrator Setup (One-Time)**

#### **Step 1: Configure Webhook Secrets in Supabase**
```bash
# Via Supabase Dashboard → Project Settings → Environment Variables
UBER_EATS_WEBHOOK_SECRET=uber_webhook_secret_from_portal
DELIVEROO_WEBHOOK_SECRET=deliveroo_webhook_secret_from_portal  
JUST_EAT_WEBHOOK_SECRET=just_eat_webhook_secret_from_portal

# Additional system secrets
SUPABASE_URL=https://axlhezpjvyecntzsqczk.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your_service_role_jwt_token
```

#### **Step 2: Platform Partner Portal Configuration**
For each platform, register webhook URLs:

**Uber Eats Developer Portal:**
```
Webhook URL: https://axlhezpjvyecntzsqczk.supabase.co/functions/v1/uber-eats-webhook
Events: order.created, order.updated, order.cancelled
```

**Deliveroo Partner Portal:**
```
Webhook URL: https://axlhezpjvyecntzsqczk.supabase.co/functions/v1/deliveroo-webhook  
Events: order.created, order.updated, order.cancelled, rider.assigned
```

**Just Eat Partner Centre:**
```
Webhook URL: https://axlhezpjvyecntzsqczk.supabase.co/functions/v1/just-eat-webhook
Events: OrderPlaced, OrderAccepted, OrderCancelled
```

### **Phase 2: Restaurant Owner Setup (Per Location)**

#### **Step 1: Navigate to Platform Settings**
- URL: `https://your-pos-domain.com/delivery/platform-settings`
- Action: Click "Add Integration" for desired platform

#### **Step 2: Platform Setup Wizard**
- **Step 1**: Select platform (Uber Eats, Deliveroo, or Just Eat)  
- **Step 2**: Enter platform credentials via secure form
- **Step 3**: Test connection with entered credentials
- **Step 4**: Activate integration if test passes

#### **Step 3: Platform Credential Entry**
Each platform requires different credentials:

**Uber Eats Form Fields:**
```
🔑 Client ID: [Password Field] 
🔑 Client Secret: [Password Field]
🏪 Store ID: [Text Field]
🏪 Platform Restaurant ID: [Text Field]
```

**Deliveroo Form Fields:**
```
🔑 Client ID: [Password Field]
🔑 Client Secret: [Password Field] 
🏪 Restaurant ID: [Text Field]
🏪 Platform Restaurant ID: [Text Field]
```

**Just Eat Form Fields:**
```
🔑 API Token: [Password Field]
🏪 Restaurant ID: [Text Field]
🏪 Platform Restaurant ID: [Text Field]
```

---

## 🔐 **CURRENT SECURITY IMPLEMENTATION**

### **Frontend Security:**
- ✅ Password fields for sensitive credentials
- ✅ Password visibility toggle (eye icon)
- ✅ Client-side form validation
- ✅ HTTPS transmission (in production)

### **Backend Security:**
- ✅ Credentials stored as JSONB with database encryption at rest
- ✅ RLS (Row Level Security) policies on platform_integrations table
- ❌ **No Vault encryption** (recommended upgrade)

### **Webhook Security:**
- ✅ HMAC SHA256 signature verification implemented
- ❌ **Webhook secrets not configured** (critical gap)

---

## 🚨 **CURRENT GAPS IN CREDENTIAL MANAGEMENT**

### **Critical Gap #1: Webhook Secrets Not Configured**
**Issue**: Webhook functions expect environment variables that aren't set
```typescript
// These will be undefined:
Deno.env.get('UBER_EATS_CLIENT_SECRET')     // ❌ Not configured
Deno.env.get('DELIVEROO_WEBHOOK_SECRET')    // ❌ Not configured  
Deno.env.get('JUST_EAT_WEBHOOK_SECRET')     // ❌ Not configured
```

**Impact**: All webhooks will return 401 Unauthorized  
**Solution**: Configure these in Supabase project settings

### **Critical Gap #2: No Webhook URL Registration Workflow**
**Issue**: No system to register generated webhook URLs with platforms  
**Current**: URLs are generated but not automatically registered  
**Solution**: Manual registration required in each platform's portal

### **Critical Gap #3: No Vault Migration**
**Issue**: Sensitive credentials stored as plain JSONB  
**Security Risk**: Database breach exposes API credentials  
**Solution**: Migrate to Supabase Vault storage pattern

---

## 🔧 **IMMEDIATE FIXES REQUIRED**

### **Fix #1: Configure Webhook Environment Variables**

**Via Supabase Dashboard:**
1. Go to: `https://supabase.com/dashboard/project/axlhezpjvyecntzsqczk/settings/environment`
2. Add these environment variables:

```bash
UBER_EATS_CLIENT_SECRET=[Same as OAuth client_secret from Uber developer portal]
DELIVEROO_WEBHOOK_SECRET=[Webhook secret from Deliveroo developer portal]
JUST_EAT_WEBHOOK_SECRET=[Webhook secret from Just Eat partner centre]

# System variables (already configured)
SUPABASE_URL=https://axlhezpjvyecntzsqczk.supabase.co
SUPABASE_SERVICE_ROLE_KEY=[Your service role JWT token]
```

**Via Supabase CLI:**
```bash
supabase secrets set UBER_EATS_CLIENT_SECRET=your_uber_client_secret
supabase secrets set DELIVEROO_WEBHOOK_SECRET=your_deliveroo_webhook_secret  
supabase secrets set JUST_EAT_WEBHOOK_SECRET=your_just_eat_webhook_secret
```

### **Fix #2: Create Environment Setup Script**

**New File: `scripts/setup-webhook-secrets.ps1`**
```powershell
# Script to configure webhook secrets in Supabase
Write-Host "Setting up webhook secrets..."

# Prompt for each platform's webhook secret
$uberSecret = Read-Host "Enter Uber Eats Client Secret" -AsSecureString
$deliverooSecret = Read-Host "Enter Deliveroo Webhook Secret" -AsSecureString  
$justEatSecret = Read-Host "Enter Just Eat Webhook Secret" -AsSecureString

# Convert to plain text for CLI
$uberPlain = [Runtime.InteropServices.Marshal]::PtrToStringAuto([Runtime.InteropServices.Marshal]::SecureStringToBSTR($uberSecret))
$deliverooPlain = [Runtime.InteropServices.Marshal]::PtrToStringAuto([Runtime.InteropServices.Marshal]::SecureStringToBSTR($deliverooSecret))
$justEatPlain = [Runtime.InteropServices.Marshal]::PtrToStringAuto([Runtime.InteropServices.Marshal]::SecureStringToBSTR($justEatSecret))

# Set via Supabase CLI
supabase secrets set UBER_EATS_CLIENT_SECRET=$uberPlain
supabase secrets set DELIVEROO_WEBHOOK_SECRET=$deliverooPlain
supabase secrets set JUST_EAT_WEBHOOK_SECRET=$justEatPlain

Write-Host "✅ Webhook secrets configured!"
```

### **Fix #3: Webhook URL Registration Instructions**

**Create: `docs/WEBHOOK_REGISTRATION_GUIDE.md`**
Document with step-by-step instructions for registering webhook URLs in each platform portal.

---

## 📊 **CREDENTIAL FLOW DIAGRAM**

```
                    CREDENTIAL MANAGEMENT FLOW
                           
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  Platform       │    │     POS Pro     │    │    Supabase     │
│  Developer      │    │   Frontend      │    │   Database      │
│  Portal         │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │ 1. Get API Credentials │                      │
         ├──────────────────────►│                       │
         │                       │ 2. Store via Form     │
         │                       ├──────────────────────►│
         │                       │                       │
         │ 3. Get Webhook Secret  │                      │
         ├──────────────────────►│                       │
         │                       │ 4. Configure as       │
         │                       │    Environment Var    │
         │                       ├──────────────────────►│
         │                       │                       │
         │ 5. Register Webhook URL│                      │
         │    (Manual Step)      │◄──────────────────────┤
         ◄───────────────────────┤                       │
```

---

## 🔐 **CURRENT vs RECOMMENDED SECURITY**

### **Current Implementation:**
```
✅ Frontend: Password-masked input fields
✅ Transport: HTTPS encryption
✅ Database: Encryption at rest (Supabase default)
✅ Access: RLS policies restrict access
❌ Storage: Plain JSONB (not vault encrypted)
❌ Webhook Secrets: Not configured
❌ Secret Rotation: No automated rotation
```

### **Recommended Production Security:**
```
✅ Frontend: Same as current
✅ Transport: Same as current  
✅ Database: Supabase Vault for sensitive fields
✅ Access: Same as current
✅ Storage: Vault keys instead of actual credentials
✅ Webhook Secrets: Supabase environment variables
✅ Secret Rotation: Automated vault key rotation
```

---

## 🛡️ **VAULT MIGRATION IMPLEMENTATION**

### **Recommended Database Schema Change:**
```sql
-- Instead of storing actual credentials
credentials: {
  "client_id": "actual_secret",
  "client_secret": "actual_secret"
}

-- Store vault key references
credentials: {
  "client_id_vault_key": "uber_eats_org123_client_id",
  "client_secret_vault_key": "uber_eats_org123_client_secret"  
}
```

### **Service Layer Update Required:**
```typescript
// New methods needed in deliveryPlatformService:

storeCredentialsInVault: async (
  organizationId: string,
  platform: PlatformEnum,
  credentials: Record<string, string>
): Promise<Record<string, string>> => {
  const vaultKeys: Record<string, string> = {};
  
  for (const [key, value] of Object.entries(credentials)) {
    const vaultKey = `${platform}_${organizationId}_${key}`;
    
    // Store in Supabase Vault via Edge Function
    await supabase.functions.invoke('store-vault-secret', {
      body: { key: vaultKey, value }
    });
    
    vaultKeys[`${key}_vault_key`] = vaultKey;
  }
  
  return vaultKeys;
},

retrieveCredentialsFromVault: async (
  vaultKeys: Record<string, string>
): Promise<Record<string, string>> => {
  const credentials: Record<string, string> = {};
  
  for (const [field, vaultKey] of Object.entries(vaultKeys)) {
    if (field.endsWith('_vault_key')) {
      const actualField = field.replace('_vault_key', '');
      
      // Retrieve from Supabase Vault
      const { data } = await supabase.functions.invoke('get-vault-secret', {
        body: { key: vaultKey }
      });
      
      credentials[actualField] = data?.value;
    }
  }
  
  return credentials;
}
```

---

## 📋 **MANUAL SETUP CHECKLIST (CURRENT PROCESS)**

### **System Administrator Tasks:**

#### **1. Supabase Environment Variables** ⚠️ **REQUIRED NOW**
```bash
# Set via Supabase Dashboard or CLI
UBER_EATS_CLIENT_SECRET=your_uber_client_secret
DELIVEROO_WEBHOOK_SECRET=your_deliveroo_webhook_secret
JUST_EAT_WEBHOOK_SECRET=your_just_eat_webhook_secret
```

#### **2. Platform Developer Portal Setup** ⚠️ **REQUIRED FOR EACH PLATFORM**

**Uber Eats:**
1. Create developer account at https://developer.uber.com
2. Create new app for restaurant integration
3. Get Client ID and Client Secret 
4. Register webhook URL: `https://axlhezpjvyecntzsqczk.supabase.co/functions/v1/uber-eats-webhook`
5. Enable order events: `order.created`, `order.updated`, `order.cancelled`

**Deliveroo:**
1. Apply for API access at https://developer.deliveroo.com  
2. Get Client ID and Client Secret
3. Generate webhook secret
4. Register webhook URL: `https://axlhezpjvyecntzsqczk.supabase.co/functions/v1/deliveroo-webhook`
5. Subscribe to events: `order.*`, `rider.*`

**Just Eat:**
1. Access Partner Centre at https://developers.just-eat.com
2. Generate API Bearer token
3. Generate webhook secret
4. Register webhook URL: `https://axlhezpjvyecntzsqczk.supabase.co/functions/v1/just-eat-webhook`
5. Subscribe to events: `OrderPlaced`, `OrderCancelled`, etc.

### **Restaurant Owner Tasks:**

#### **1. Navigate to Platform Settings**
```
🌐 URL: https://your-pos-domain.com/delivery/platform-settings
🎯 Action: Click "Add Integration" for each platform
```

#### **2. Enter Platform Credentials** (Per Platform)
Use the setup wizard to enter credentials obtained from developer portals.

#### **3. Test & Activate**
- Test connection via UI
- Activate integration if test passes
- Monitor status indicators

---

## 🔧 **CURRENT IMPLEMENTATION ANALYSIS**

### **What Works Well:**
✅ **Secure credential collection** via password-masked forms  
✅ **Database storage** with RLS policies  
✅ **Testing workflow** before activation  
✅ **Platform-specific field validation**  
✅ **Multi-organization support**  

### **What Needs Immediate Attention:**
❌ **Webhook secrets not configured** - Webhooks will fail  
❌ **No vault migration** - Security vulnerability  
❌ **No webhook URL registration automation** - Manual process  
❌ **No secret rotation** - Security best practice missing  

---

## 🚀 **RECOMMENDED IMMEDIATE ACTIONS**

### **Priority 1: Configure Webhook Secrets (CRITICAL)**
**Time Required**: 30 minutes  
**Action**: Set environment variables in Supabase project settings

**Via Supabase Dashboard:**
```
Project → Settings → Environment Variables → Add:
- UBER_EATS_CLIENT_SECRET
- DELIVEROO_WEBHOOK_SECRET  
- JUST_EAT_WEBHOOK_SECRET
```

**Via CLI:**
```bash
supabase secrets set --project axlhezpjvyecntzsqczk UBER_EATS_CLIENT_SECRET=your_secret
supabase secrets set --project axlhezpjvyecntzsqczk DELIVEROO_WEBHOOK_SECRET=your_secret
supabase secrets set --project axlhezpjvyecntzsqczk JUST_EAT_WEBHOOK_SECRET=your_secret
```

### **Priority 2: Create Setup Documentation**
**Time Required**: 2 hours  
**Action**: Comprehensive setup guide for restaurant owners

### **Priority 3: Vault Migration (Security Enhancement)**  
**Time Required**: 4-6 hours  
**Action**: Implement Supabase Vault storage for sensitive credentials

---

## 🎯 **PRODUCTION DEPLOYMENT SECRETS CHECKLIST**

### **Before Production Deployment:**
- [ ] **Webhook secrets configured** in Supabase environment
- [ ] **Platform developer accounts** created for production
- [ ] **Webhook URLs registered** in all platform portals  
- [ ] **Test credentials working** in sandbox environments
- [ ] **Production credentials** obtained from platforms
- [ ] **Vault migration completed** (recommended)
- [ ] **Secret rotation schedule** established
- [ ] **Access audit logs** configured
- [ ] **Backup secret storage** documented

### **For Each Restaurant Location:**
- [ ] **Platform accounts** created with the platforms
- [ ] **Developer portal access** granted to restaurant
- [ ] **API credentials** obtained from each platform
- [ ] **Setup wizard completed** for each platform
- [ ] **Connection testing** passed for each integration
- [ ] **Integration activated** and monitored

---

## 📖 **OPERATIONAL WORKFLOW SUMMARY**

### **Day-to-Day Operations:**
1. **Restaurant owners** manage their platform credentials via the UI
2. **System automatically** handles webhook authentication 
3. **Platform orders** flow through secure webhooks
4. **Credentials are used** by API clients for outbound calls
5. **Status updates** sync bidirectionally using stored credentials

### **Credential Lifecycle:**
1. **Initial Setup**: Restaurant enters credentials via setup wizard
2. **Storage**: Credentials stored in database (with vault migration recommended)
3. **Usage**: Clients retrieve credentials for API calls
4. **Rotation**: Manual rotation via platform portals (automated rotation recommended)
5. **Deactivation**: Credentials can be disabled via toggle without deletion

---

## 💡 **RECOMMENDED ENHANCEMENTS**

### **Short-Term (Next Week):**
1. **Configure webhook secrets** immediately
2. **Create setup documentation** for restaurant owners  
3. **Add credential validation** in forms
4. **Implement test connection** functionality

### **Medium-Term (Next Month):**  
1. **Vault migration** for enhanced security
2. **Automated webhook URL registration** 
3. **Credential rotation workflows**
4. **Advanced security monitoring**

### **Long-Term (Next Quarter):**
1. **SSO integration** with platform portals
2. **Automated credential renewal**
3. **Advanced threat detection**
4. **Compliance reporting**

---

## ⚠️ **CRITICAL NEXT STEP**

**IMMEDIATE ACTION REQUIRED**: Configure webhook secrets in Supabase environment variables.

**Without these secrets, the entire webhook system will fail with 401 errors.**

**Command to run:**
```bash
# Set webhook secrets in Supabase project
supabase secrets set --project axlhezpjvyecntzsqczk UBER_EATS_CLIENT_SECRET=placeholder_secret
supabase secrets set --project axlhezpjvyecntzsqczk DELIVEROO_WEBHOOK_SECRET=placeholder_secret
supabase secrets set --project axlhezpjvyecntzsqczk JUST_EAT_WEBHOOK_SECRET=placeholder_secret
```

**Then**: Obtain real secrets from platform developer portals and update the values.

---

**Current Status**: ✅ UI & Database Ready, ❌ Webhook Secrets Missing  
**Security Level**: Good foundations, needs Vault migration  
**Next Action**: Configure webhook environment variables immediately
